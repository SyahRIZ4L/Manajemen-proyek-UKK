<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Start Card Pop-up</title>
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
</head>
<body>
    <div class="container mt-5">
        <h2>Test Start Card Pop-up</h2>
        <div class="alert alert-info">
            <strong>Panduan Test:</strong>
            <ul>
                <li>Klik tombol "Start Card" untuk menguji pop-up konfirmasi</li>
                <li>Pop-up harus muncul dengan pesan konfirmasi</li>
                <li>Klik "Mulai Kerjakan" untuk menguji fungsi update status</li>
                <li>Periksa console browser untuk log debugging</li>
            </ul>
        </div>

        <!-- Test Card -->
        <div class="card mb-3">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h5 class="card-title">Test Card - Sample Task</h5>
                        <p class="card-text text-muted">This is a test card for testing the start confirmation modal.</p>
                        <span class="badge bg-secondary">To Do</span>
                    </div>
                    <div class="col-md-4 text-end">
                        <button class="btn btn-success start-work-btn"
                                data-card-id="999"
                                data-card-title="Test Card - Sample Task">
                            <i class="bi bi-play"></i> Start Card
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Console Output -->
        <div class="card">
            <div class="card-header">
                <h6>Console Output (for debugging)</h6>
            </div>
            <div class="card-body">
                <div id="consoleOutput" class="bg-dark text-light p-3 rounded" style="height: 200px; overflow-y: auto; font-family: monospace; font-size: 12px;">
                    Console logs will appear here...
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Override console.log to display in the page
        const originalLog = console.log;
        const consoleOutput = document.getElementById('consoleOutput');

        function logToPage(message, type = 'log') {
            const timestamp = new Date().toLocaleTimeString();
            const colorClass = type === 'error' ? 'text-danger' : type === 'warn' ? 'text-warning' : 'text-light';
            consoleOutput.innerHTML += `<div class="${colorClass}">[${timestamp}] ${message}</div>`;
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
        }

        console.log = function(...args) {
            originalLog.apply(console, args);
            logToPage(args.join(' '));
        };

        console.error = function(...args) {
            originalLog.apply(console, args);
            logToPage(args.join(' '), 'error');
        };

        // Global variables to prevent multiple initializations
        let eventListenersInitialized = false;

        document.addEventListener('DOMContentLoaded', function() {
            console.log('Test page loaded, setting up event listeners...');

            // Prevent multiple initialization
            if (eventListenersInitialized) {
                console.log('Event listeners already initialized, skipping...');
                return;
            }

            initializeCardButtons();
            eventListenersInitialized = true;
        });

        function initializeCardButtons() {
            console.log('Initializing card buttons...');

            // Start work buttons dengan konfirmasi
            const startWorkButtons = document.querySelectorAll('.start-work-btn');
            console.log(`Found ${startWorkButtons.length} start work buttons`);

            startWorkButtons.forEach((button, index) => {
                const cardId = button.getAttribute('data-card-id');
                const cardTitle = button.getAttribute('data-card-title');
                console.log(`Setting up start button ${index + 1} for card ${cardId}: ${cardTitle}`);

                button.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();

                    console.log(`Start button clicked for card ${cardId}`);

                    // Prevent double-clicks
                    if (button.disabled) {
                        console.log('Button already processing, ignoring click');
                        return;
                    }

                    const cardId = this.getAttribute('data-card-id');
                    const cardTitle = this.getAttribute('data-card-title');

                    console.log('Showing confirmation modal for start card...');
                    showConfirmationModal(
                        'Mulai Mengerjakan Card',
                        `Apakah Anda yakin ingin mulai mengerjakan "${cardTitle}"? Status akan berubah menjadi In Progress dan timer akan dimulai secara otomatis.`,
                        'Mulai Kerjakan',
                        'btn-success',
                        function() {
                            console.log(`Confirmed: Starting card ${cardId}`);
                            // In real application, this would call updateCardStatus
                            alert('Card would be started here! (This is just a test)');
                        }
                    );
                });
            });

            console.log('All card buttons initialized successfully');
        }

        // Show confirmation modal function
        function showConfirmationModal(title, message, confirmText, confirmClass, onConfirm) {
            console.log('showConfirmationModal called with:', { title, confirmText });

            const modalId = 'confirmActionModal';
            const uniqueId = modalId + '_' + Date.now(); // Add timestamp to prevent conflicts

            // Remove any existing modals
            const existingModals = document.querySelectorAll('[id^="confirmActionModal"]');
            existingModals.forEach(modal => {
                const bootstrapModal = bootstrap.Modal.getInstance(modal);
                if (bootstrapModal) {
                    bootstrapModal.dispose();
                }
                modal.remove();
            });

            // Create modal HTML with unique ID
            const modalHTML = `
                <div class="modal fade" id="${uniqueId}" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content shadow-lg">
                            <div class="modal-header border-bottom-0 bg-light">
                                <h5 class="modal-title fw-bold">
                                    <i class="bi bi-question-circle-fill me-2 text-primary"></i>${title}
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body py-4">
                                <div class="d-flex align-items-start">
                                    <div class="flex-shrink-0 me-3">
                                        <i class="bi bi-info-circle-fill text-info fs-3"></i>
                                    </div>
                                    <div class="flex-grow-1">
                                        <p class="mb-0 fs-6">${message}</p>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer border-top-0">
                                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                                    <i class="bi bi-x me-1"></i>Batal
                                </button>
                                <button type="button" class="btn ${confirmClass}" id="confirmBtn_${uniqueId}">
                                    <i class="bi bi-check me-1"></i>${confirmText}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Add modal to body
            document.body.insertAdjacentHTML('beforeend', modalHTML);

            const modalElement = document.getElementById(uniqueId);
            const confirmButton = document.getElementById(`confirmBtn_${uniqueId}`);

            console.log('Modal created, showing...', uniqueId);

            // Show modal
            const modal = new bootstrap.Modal(modalElement, {
                backdrop: 'static',
                keyboard: false
            });

            modal.show();

            // Handle confirm button click
            confirmButton.addEventListener('click', function(e) {
                e.preventDefault();
                console.log('Confirm button clicked');

                // Disable button to prevent double-clicks
                confirmButton.disabled = true;
                confirmButton.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Processing...';

                // Hide modal
                modal.hide();

                // Execute callback after modal is hidden
                setTimeout(() => {
                    if (onConfirm && typeof onConfirm === 'function') {
                        console.log('Executing confirm callback');
                        onConfirm();
                    }
                }, 300);
            });

            // Clean up modal after hide
            modalElement.addEventListener('hidden.bs.modal', function() {
                console.log('Modal hidden, cleaning up');
                modal.dispose();
                this.remove();
            });

            // Focus on confirm button after modal is shown
            modalElement.addEventListener('shown.bs.modal', function() {
                confirmButton.focus();
            });
        }
    </script>
</body>
</html>
